<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Data Sekolah</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
    }
    html {
      height: 100%;
    }
    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .upload-progress {
      background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
      height: 4px;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="min-h-full p-8">
  <div class="max-w-2xl mx-auto">
   <h1 id="formTitle" class="text-3xl font-bold mb-2 text-center">Form Data Sekolah</h1>
   <p class="text-gray-600 text-center mb-8">Silakan lengkapi data sekolah di bawah ini</p>
   <div id="loadingMessage" class="flex items-center justify-center gap-3 p-4 bg-blue-50 rounded-lg mb-6">
    <div class="loading-spinner"></div><span class="text-blue-700">Memuat data dari spreadsheet...</span>
   </div>
   <div id="errorMessage" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg mb-6">
    <p class="text-red-700"></p>
   </div>
   <div id="urlWarning" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-6">
    <div class="flex items-start gap-3">
     <div class="text-yellow-600 text-xl">
      ⚠️
     </div>
     <div>
      <p class="text-yellow-800 font-semibold mb-2">Perhatian: URL Google Apps Script belum dikonfigurasi!</p>
      <p class="text-yellow-700 text-sm mb-2">Untuk menggunakan form ini, Anda perlu:</p>
      <ol class="text-yellow-700 text-sm list-decimal list-inside space-y-1">
       <li>Deploy Google Apps Script sebagai Web App</li>
       <li>Salin URL deployment yang dihasilkan</li>
       <li>Ganti <code class="bg-yellow-100 px-1 rounded">GANTI_DENGAN_DEPLOYMENT_ID_ANDA</code> di kode dengan URL tersebut</li>
      </ol>
     </div>
    </div>
   </div>
   <div id="uploadProgress" class="hidden mb-6">
    <div class="flex justify-between text-sm text-gray-600 mb-2"><span>Mengupload file...</span> <span id="progressText">0%</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2">
     <div id="progressBar" class="upload-progress w-0 h-2 rounded-full"></div>
    </div>
   </div>
   <form id="schoolForm" class="space-y-6 bg-white p-8 rounded-xl shadow-lg" style="display: none;">
    <div><label for="kabupatenKota" class="block text-sm font-semibold mb-2 text-gray-700">Kabupaten/Kota</label> <select id="kabupatenKota" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required> <option value="">-- Pilih Kabupaten/Kota --</option> </select>
    </div>
    <div><label for="jenjang" class="block text-sm font-semibold mb-2 text-gray-700">Jenjang</label> <select id="jenjang" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required disabled> <option value="">-- Pilih Jenjang --</option> </select>
    </div>
    <div><label for="npsn" class="block text-sm font-semibold mb-2 text-gray-700">NPSN</label> <select id="npsn" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required disabled> <option value="">-- Pilih NPSN --</option> </select>
    </div>
    <div><label for="namaSatuan" class="block text-sm font-semibold mb-2 text-gray-700">Nama Satuan Pendidikan</label> <input type="text" id="namaSatuan" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" readonly>
    </div>
    <div><label for="namaPenanggungJawab" class="block text-sm font-semibold mb-2 text-gray-700">Nama Penanggung Jawab IFP</label> <input type="text" id="namaPenanggungJawab" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nama penanggung jawab" required>
    </div>
    <div><label for="noTelp" class="block text-sm font-semibold mb-2 text-gray-700">No Telp Yang Bisa Dihubungi</label> <input type="tel" id="noTelp" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contoh: 08123456789" required>
    </div>
    <div><label for="serialNumber" class="block text-sm font-semibold mb-2 text-gray-700">No Serial/Serial Number IFP</label> <input type="text" id="serialNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nomor serial IFP" required>
    </div>
    <div><label for="serialPhoto" class="block text-sm font-semibold mb-2 text-gray-700">Upload Foto Serial Number</label>
     <div class="relative"><input type="file" id="serialPhoto" accept=".jpg,.jpeg" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
      <p class="text-xs text-gray-500 mt-1">Format yang didukung: JPG saja (Maks. 10MB)</p>
     </div>
     <div id="serialPhotoInfo" class="hidden mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm text-green-700"><span class="font-semibold">File terpilih:</span> <span id="serialPhotoName"></span>
     </div>
    </div>
    <div><label for="bastFile" class="block text-sm font-semibold mb-2 text-gray-700">Upload BAST (Berita Acara Serah Terima)</label>
     <div class="relative"><input type="file" id="bastFile" accept=".pdf" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
      <p class="text-xs text-gray-500 mt-1">Format yang didukung: PDF saja (Maks. 10MB)</p>
     </div>
     <div id="bastFileInfo" class="hidden mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm text-green-700"><span class="font-semibold">File terpilih:</span> <span id="bastFileName"></span>
     </div>
    </div>
    <div><label for="bappFile" class="block text-sm font-semibold mb-2 text-gray-700">Upload BAPP (Berita Acara Pemeriksaan dan Penerimaan)</label>
     <div class="relative"><input type="file" id="bappFile" accept=".pdf" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
      <p class="text-xs text-gray-500 mt-1">Format yang didukung: PDF saja (Maks. 10MB)</p>
     </div>
     <div id="bappFileInfo" class="hidden mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm text-green-700"><span class="font-semibold">File terpilih:</span> <span id="bappFileName"></span>
     </div>
    </div>
    <div><label for="deliveryPhotos" class="block text-sm font-semibold mb-2 text-gray-700">Foto dari Kedatangan IFP-BAST-Penginstalan-BAPP-Pemanfaatan</label>
     <div class="relative"><input type="file" id="deliveryPhotos" accept=".jpg,.jpeg" multiple class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
      <p class="text-xs text-gray-500 mt-1">Format yang didukung: JPG saja (Maks. 5 foto, masing-masing 10MB)</p>
     </div>
     <div id="deliveryPhotosInfo" class="hidden mt-2 space-y-1">
      <div class="text-sm font-semibold text-green-700">
       Foto terpilih:
      </div>
      <div id="deliveryPhotosList" class="space-y-1"></div>
     </div>
    </div><button type="submit" id="submitBtn" class="w-full py-3 px-6 rounded-lg font-semibold text-white transition-colors"> Kirim Data </button>
    <div id="successMessage" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
     <p class="text-green-700 text-center font-semibold">✓ Data berhasil dikirim!</p>
    </div>
   </form>
  </div>
  <script>
    const defaultConfig = {
      background_color: "#f0f9ff",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#6b7280",
      form_title: "Form Data Sekolah",
      submit_button_text: "Kirim Data",
      font_family: "system-ui",
      font_size: 16
    };

    let schoolData = [];
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-5DI1rYTsqo50b8unUKAzJ6U7ryQfRfXMlSzH8paDKHsVhcSqPmL1KtvJvTaved0-LmdF5R3K_vaD/pub?output=csv";

    async function loadSpreadsheetData() {
      try {
        const response = await fetch(SHEET_URL);
        const csvText = await response.text();
        
        const rows = csvText.split('\n').map(row => {
          const values = [];
          let current = '';
          let inQuotes = false;
          
          for (let i = 0; i < row.length; i++) {
            const char = row[i];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          return values;
        });
        
        const headers = rows[0];
        schoolData = rows.slice(1).filter(row => row.length > 1 && row[0]).map(row => ({
          kabupatenKota: row[0] || '',
          jenjang: row[1] || '',
          npsn: row[2] || '',
          namaSatuan: row[3] || ''
        }));
        
        populateKabupatenKota();
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('schoolForm').style.display = 'block';
        
        // Hide URL warning if script URL is configured
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPxd9zBjL92FztO-HW3hVCY0PGGNX4867sOIGCry2uwcNzYfBGCmK6EGHSqu-u6wRe/exec';
        if (!SCRIPT_URL.includes('GANTI_DENGAN_DEPLOYMENT_ID_ANDA')) {
          document.getElementById('urlWarning').style.display = 'none';
        }
      } catch (error) {
        document.getElementById('loadingMessage').style.display = 'none';
        const errorMsg = document.getElementById('errorMessage');
        errorMsg.querySelector('p').textContent = 'Gagal memuat data. Pastikan spreadsheet dapat diakses publik.';
        errorMsg.classList.remove('hidden');
      }
    }

    function populateKabupatenKota() {
      const kabupatenSet = new Set(schoolData.map(item => item.kabupatenKota).filter(k => k));
      const kabupatenSelect = document.getElementById('kabupatenKota');
      
      Array.from(kabupatenSet).sort().forEach(kabupaten => {
        const option = document.createElement('option');
        option.value = kabupaten;
        option.textContent = kabupaten;
        kabupatenSelect.appendChild(option);
      });
    }

    document.getElementById('kabupatenKota').addEventListener('change', function() {
      const selectedKabupaten = this.value;
      const jenjangSelect = document.getElementById('jenjang');
      const npsnSelect = document.getElementById('npsn');
      const namaSatuanInput = document.getElementById('namaSatuan');
      
      jenjangSelect.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
      npsnSelect.innerHTML = '<option value="">-- Pilih NPSN --</option>';
      namaSatuanInput.value = '';
      npsnSelect.disabled = true;
      
      if (selectedKabupaten) {
        const filteredData = schoolData.filter(item => item.kabupatenKota === selectedKabupaten);
        const jenjangSet = new Set(filteredData.map(item => item.jenjang).filter(j => j));
        
        Array.from(jenjangSet).sort().forEach(jenjang => {
          const option = document.createElement('option');
          option.value = jenjang;
          option.textContent = jenjang;
          jenjangSelect.appendChild(option);
        });
        
        jenjangSelect.disabled = false;
      } else {
        jenjangSelect.disabled = true;
      }
    });

    document.getElementById('jenjang').addEventListener('change', function() {
      const selectedKabupaten = document.getElementById('kabupatenKota').value;
      const selectedJenjang = this.value;
      const npsnSelect = document.getElementById('npsn');
      const namaSatuanInput = document.getElementById('namaSatuan');
      
      npsnSelect.innerHTML = '<option value="">-- Pilih NPSN --</option>';
      namaSatuanInput.value = '';
      
      if (selectedJenjang) {
        const filteredData = schoolData.filter(item => 
          item.kabupatenKota === selectedKabupaten && 
          item.jenjang === selectedJenjang
        );
        
        filteredData.sort((a, b) => a.npsn.localeCompare(b.npsn)).forEach(item => {
          const option = document.createElement('option');
          option.value = item.npsn;
          option.textContent = `${item.npsn} - ${item.namaSatuan}`;
          option.dataset.namaSatuan = item.namaSatuan;
          npsnSelect.appendChild(option);
        });
        
        npsnSelect.disabled = false;
      } else {
        npsnSelect.disabled = true;
      }
    });

    document.getElementById('npsn').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const namaSatuanInput = document.getElementById('namaSatuan');
      
      if (selectedOption.dataset.namaSatuan) {
        namaSatuanInput.value = selectedOption.dataset.namaSatuan;
      } else {
        namaSatuanInput.value = '';
      }
    });

    // File upload handlers
    function validateFile(file, fileType = 'pdf') {
      const maxSize = 10 * 1024 * 1024; // 10MB
      let allowedTypes = [];
      let errorMessage = '';
      
      if (fileType === 'pdf') {
        allowedTypes = ['application/pdf'];
        errorMessage = 'Format file tidak didukung. Hanya file PDF yang diperbolehkan.';
      } else if (fileType === 'jpg') {
        allowedTypes = ['image/jpeg', 'image/jpg'];
        errorMessage = 'Format file tidak didukung. Hanya file JPG yang diperbolehkan.';
      }
      
      if (file.size > maxSize) {
        return { valid: false, message: 'Ukuran file terlalu besar. Maksimal 10MB.' };
      }
      
      if (!allowedTypes.includes(file.type)) {
        return { valid: false, message: errorMessage };
      }
      
      return { valid: true };
    }

    function showFileError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-700';
      errorDiv.textContent = message;
      return errorDiv;
    }

    document.getElementById('serialPhoto').addEventListener('change', function() {
      const file = this.files[0];
      const fileInfo = document.getElementById('serialPhotoInfo');
      const fileName = document.getElementById('serialPhotoName');
      
      // Remove any existing error messages
      const existingError = this.parentNode.querySelector('.bg-red-50');
      if (existingError) existingError.remove();
      
      if (file) {
        const validation = validateFile(file, 'jpg');
        if (validation.valid) {
          fileName.textContent = file.name;
          fileInfo.classList.remove('hidden');
        } else {
          this.value = '';
          fileInfo.classList.add('hidden');
          this.parentNode.appendChild(showFileError(validation.message));
        }
      } else {
        fileInfo.classList.add('hidden');
      }
    });

    document.getElementById('deliveryPhotos').addEventListener('change', function() {
      const files = Array.from(this.files);
      const fileInfo = document.getElementById('deliveryPhotosInfo');
      const filesList = document.getElementById('deliveryPhotosList');
      
      // Remove any existing error messages
      const existingError = this.parentNode.querySelector('.bg-red-50');
      if (existingError) existingError.remove();
      
      if (files.length > 0) {
        // Check if more than 5 files
        if (files.length > 5) {
          this.value = '';
          fileInfo.classList.add('hidden');
          this.parentNode.appendChild(showFileError('Maksimal 5 foto yang dapat diupload.'));
          return;
        }
        
        // Validate each file
        let allValid = true;
        let errorMessage = '';
        
        for (let file of files) {
          const validation = validateFile(file, 'jpg');
          if (!validation.valid) {
            allValid = false;
            errorMessage = validation.message;
            break;
          }
        }
        
        if (allValid) {
          // Display all selected files
          filesList.innerHTML = '';
          files.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'p-2 bg-green-50 border border-green-200 rounded text-sm text-green-700';
            fileDiv.innerHTML = `<span class="font-semibold">Foto ${index + 1}:</span> ${file.name}`;
            filesList.appendChild(fileDiv);
          });
          fileInfo.classList.remove('hidden');
        } else {
          this.value = '';
          fileInfo.classList.add('hidden');
          this.parentNode.appendChild(showFileError(errorMessage));
        }
      } else {
        fileInfo.classList.add('hidden');
      }
    });

    document.getElementById('bastFile').addEventListener('change', function() {
      const file = this.files[0];
      const fileInfo = document.getElementById('bastFileInfo');
      const fileName = document.getElementById('bastFileName');
      
      // Remove any existing error messages
      const existingError = this.parentNode.querySelector('.bg-red-50');
      if (existingError) existingError.remove();
      
      if (file) {
        const validation = validateFile(file, 'pdf');
        if (validation.valid) {
          fileName.textContent = file.name;
          fileInfo.classList.remove('hidden');
        } else {
          this.value = '';
          fileInfo.classList.add('hidden');
          this.parentNode.appendChild(showFileError(validation.message));
        }
      } else {
        fileInfo.classList.add('hidden');
      }
    });

    document.getElementById('bappFile').addEventListener('change', function() {
      const file = this.files[0];
      const fileInfo = document.getElementById('bappFileInfo');
      const fileName = document.getElementById('bappFileName');
      
      // Remove any existing error messages
      const existingError = this.parentNode.querySelector('.bg-red-50');
      if (existingError) existingError.remove();
      
      if (file) {
        const validation = validateFile(file, 'pdf');
        if (validation.valid) {
          fileName.textContent = file.name;
          fileInfo.classList.remove('hidden');
        } else {
          this.value = '';
          fileInfo.classList.add('hidden');
          this.parentNode.appendChild(showFileError(validation.message));
        }
      } else {
        fileInfo.classList.add('hidden');
      }
    });

    // Function to convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Function to update progress
    function updateProgress(current, total) {
      const percentage = Math.round((current / total) * 100);
      document.getElementById('progressText').textContent = `${percentage}%`;
      document.getElementById('progressBar').style.width = `${percentage}%`;
    }

    // Submit to Google Sheets function with file upload
    async function submitToGoogleSheets(formData, files) {
      // GANTI URL INI dengan Web App URL yang Anda dapatkan dari Apps Script
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPxd9zBjL92FztO-HW3hVCY0PGGNX4867sOIGCry2uwcNzYfBGCmK6EGHSqu-u6wRe/exec';
      
      try {
        // Show progress bar
        document.getElementById('uploadProgress').classList.remove('hidden');
        
        // Convert files to base64
        const fileData = {};
        let totalFiles = 0;
        let processedFiles = 0;
        
        // Count total files
        if (files.serialPhoto) totalFiles++;
        if (files.bastFile) totalFiles++;
        if (files.bappFile) totalFiles++;
        if (files.deliveryPhotos && files.deliveryPhotos.length > 0) totalFiles += files.deliveryPhotos.length;
        
        if (files.serialPhoto) {
          updateProgress(processedFiles, totalFiles);
          fileData.serialPhoto = {
            name: files.serialPhoto.name,
            data: await fileToBase64(files.serialPhoto),
            type: files.serialPhoto.type
          };
          processedFiles++;
        }
        
        if (files.bastFile) {
          updateProgress(processedFiles, totalFiles);
          fileData.bastFile = {
            name: files.bastFile.name,
            data: await fileToBase64(files.bastFile),
            type: files.bastFile.type
          };
          processedFiles++;
        }
        
        if (files.bappFile) {
          updateProgress(processedFiles, totalFiles);
          fileData.bappFile = {
            name: files.bappFile.name,
            data: await fileToBase64(files.bappFile),
            type: files.bappFile.type
          };
          processedFiles++;
        }
        
        if (files.deliveryPhotos && files.deliveryPhotos.length > 0) {
          fileData.deliveryPhotos = [];
          for (let i = 0; i < files.deliveryPhotos.length; i++) {
            updateProgress(processedFiles, totalFiles);
            const photo = files.deliveryPhotos[i];
            fileData.deliveryPhotos.push({
              name: photo.name,
              data: await fileToBase64(photo),
              type: photo.type
            });
            processedFiles++;
          }
        }
        
        updateProgress(totalFiles, totalFiles);
        
        const payload = {
          formData: formData,
          files: fileData
        };
        
        // Use no-cors mode to avoid CORS issues
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        // Since mode is 'no-cors', we can't read the response
        // We'll assume success if no error is thrown
        // Hide progress bar
        document.getElementById('uploadProgress').classList.add('hidden');
        
        return { success: true, message: 'Data berhasil dikirim' };
      } catch (error) {
        console.error('Error submitting to Google Sheets:', error);
        document.getElementById('uploadProgress').classList.add('hidden');
        return { success: false, error: error.message };
      }
    }

    document.getElementById('schoolForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.textContent;
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Mengupload file...';
      
      // Collect form data
      const formData = {
        timestamp: new Date().toLocaleString('id-ID'),
        kabupatenKota: document.getElementById('kabupatenKota').value,
        jenjang: document.getElementById('jenjang').value,
        npsn: document.getElementById('npsn').value,
        namaSatuan: document.getElementById('namaSatuan').value,
        namaPenanggungJawab: document.getElementById('namaPenanggungJawab').value,
        noTelp: document.getElementById('noTelp').value,
        serialNumber: document.getElementById('serialNumber').value
      };
      
      // Collect files
      const files = {
        serialPhoto: document.getElementById('serialPhoto').files[0] || null,
        bastFile: document.getElementById('bastFile').files[0] || null,
        bappFile: document.getElementById('bappFile').files[0] || null,
        deliveryPhotos: Array.from(document.getElementById('deliveryPhotos').files)
      };
      
      // Submit to Google Sheets with files
      const result = await submitToGoogleSheets(formData, files);
      
      // Reset button state
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      
      if (result.success) {
        const successMsg = document.getElementById('successMessage');
        let message = '✓ Data dan file berhasil diupload ke Google Drive!';
        successMsg.querySelector('p').innerHTML = message;
        successMsg.classList.remove('hidden');
        
        setTimeout(() => {
          successMsg.classList.add('hidden');
          this.reset();
          document.getElementById('jenjang').disabled = true;
          document.getElementById('npsn').disabled = true;
          document.getElementById('namaSatuan').value = '';
          document.getElementById('serialPhotoInfo').classList.add('hidden');
          document.getElementById('deliveryPhotosInfo').classList.add('hidden');
          document.getElementById('bastFileInfo').classList.add('hidden');
          document.getElementById('bappFileInfo').classList.add('hidden');
        }, 7000);
      } else {
        // Show error message
        const errorMsg = document.getElementById('errorMessage');
        errorMsg.querySelector('p').textContent = result.error || 'Gagal mengirim data. Silakan coba lagi.';
        errorMsg.classList.remove('hidden');
        
        setTimeout(() => {
          errorMsg.classList.add('hidden');
        }, 5000);
      }
    });

    async function onConfigChange(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;
      
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
      
      const formTitle = document.getElementById('formTitle');
      formTitle.textContent = config.form_title || defaultConfig.form_title;
      formTitle.style.fontSize = `${baseSize * 1.875}px`;
      formTitle.style.color = config.text_color || defaultConfig.text_color;
      
      const form = document.getElementById('schoolForm');
      form.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
      
      const labels = document.querySelectorAll('label');
      labels.forEach(label => {
        label.style.fontSize = `${baseSize * 0.875}px`;
        label.style.color = config.text_color || defaultConfig.text_color;
      });
      
      const inputs = document.querySelectorAll('select, input');
      inputs.forEach(input => {
        input.style.fontSize = `${baseSize}px`;
        input.style.color = config.text_color || defaultConfig.text_color;
      });
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.textContent = config.submit_button_text || defaultConfig.submit_button_text;
      submitBtn.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color;
      submitBtn.style.fontSize = `${baseSize}px`;
      
      const description = document.querySelector('p.text-gray-600');
      description.style.fontSize = `${baseSize}px`;
      description.style.color = config.secondary_action_color || defaultConfig.secondary_action_color;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.primary_action_color || defaultConfig.primary_action_color,
              set: (value) => {
                config.primary_action_color = value;
                window.elementSdk.setConfig({ primary_action_color: value });
              }
            },
            {
              get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
              set: (value) => {
                config.secondary_action_color = value;
                window.elementSdk.setConfig({ secondary_action_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["form_title", config.form_title || defaultConfig.form_title],
          ["submit_button_text", config.submit_button_text || defaultConfig.submit_button_text]
        ])
      });
    }

    loadSpreadsheetData();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'999b2c4a02b9db41',t:'MTc2MjMzMzM1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
